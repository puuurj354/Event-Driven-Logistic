# ============================================================================
# Nginx Reverse Proxy — API Gateway untuk Event-Driven Logistic
# ============================================================================
#
# Logic Overview:
# Nginx berfungsi sebagai single entry point (port 8080) yang merouting
# semua request ke backend services yang sesuai berdasarkan URL path.
# Ini menghilangkan kebutuhan frontend untuk mengetahui port setiap service.
#
# Route mapping:
#   /api/orders/*     → Order Service (9081)
#   /api/payments/*   → Payment Service (9082)
#   /api/products/*   → Inventory Service (9083)
#   /api/shipments/*  → Delivery Service (9084)
#   /ws               → Notification Service WebSocket (9085)
#   /api/logs/*       → Notification Service API (9085)
#   /                 → Notification Service Dashboard (9085)
# ============================================================================

# Worker processes — auto menggunakan jumlah CPU core
worker_processes auto;

# Error log — hanya warning ke atas untuk mengurangi noise
error_log /tmp/nginx-gateway-error.log warn;

# PID file — disimpan di /tmp agar tidak perlu root
pid /tmp/nginx-gateway.pid;

events {
    worker_connections 1024;  # Max koneksi per worker
}

http {
    # ── Logging ──
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';

    access_log /tmp/nginx-gateway-access.log main;  # Access log di /tmp

    # ── Performance ──
    sendfile        on;      # Efisien untuk serving static files
    keepalive_timeout 65;    # Keep-alive connections

    # ── Upstream Definitions (backend services) ──
    # Setiap upstream mendefinisikan satu backend service

    upstream order_service {
        server 127.0.0.1:9081;   # Order Service
    }

    upstream payment_service {
        server 127.0.0.1:9082;   # Payment Service
    }

    upstream inventory_service {
        server 127.0.0.1:9083;   # Inventory Service
    }

    upstream delivery_service {
        server 127.0.0.1:9084;   # Delivery Service
    }

    upstream notification_service {
        server 127.0.0.1:9085;   # Notification Service (Dashboard + WebSocket)
    }

    # ── Main Server Block ──
    server {
        listen 8080;              # API Gateway port
        server_name localhost;    # Hostname

        # ── Route: Order Service ──
        # /api/orders/* → strip /api prefix → forward ke Order Service
        location /api/orders {
            # CORS headers
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

            if ($request_method = 'OPTIONS') {
                return 204;
            }

            proxy_pass http://order_service/orders;   # Strip /api prefix
            proxy_set_header Host $host;               # Forward original host
            proxy_set_header X-Real-IP $remote_addr;   # Forward client IP
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Forward chain
            proxy_set_header X-Forwarded-Proto $scheme; # Forward protocol
        }

        # ── Route: Payment Service ──
        # /api/payments/* → strip /api prefix
        location /api/payments {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

            if ($request_method = 'OPTIONS') {
                return 204;
            }

            proxy_pass http://payment_service/payments;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ── Route: Inventory Service (Products) ──
        # /api/products/* → strip /api prefix
        location /api/products {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

            if ($request_method = 'OPTIONS') {
                return 204;
            }

            proxy_pass http://inventory_service/products;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ── Route: Delivery Service (Shipments) ──
        # /api/shipments/* → strip /api prefix
        location /api/shipments {
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

            if ($request_method = 'OPTIONS') {
                return 204;
            }

            proxy_pass http://delivery_service/shipments;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ── Route: WebSocket (Notification Service) ──
        # /ws → forward ke Notification Service dengan upgrade headers
        location /ws {
            proxy_pass http://notification_service/ws;
            proxy_http_version 1.1;                     # WebSocket butuh HTTP/1.1
            proxy_set_header Upgrade $http_upgrade;      # Header upgrade untuk WS
            proxy_set_header Connection "upgrade";       # Sinyal upgrade koneksi
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 86400s;                   # Timeout panjang untuk WS
            proxy_send_timeout 86400s;                   # Keep WS connection alive
        }

        # ── Route: Notification API (Event Logs) ──
        # /api/logs/* → forward ke Notification Service
        location /api/logs {
            proxy_pass http://notification_service/api/logs;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ── Route: Health Checks ──
        # /health/* → forward ke masing-masing service
        location /health/order {
            proxy_pass http://order_service/health;
        }
        location /health/payment {
            proxy_pass http://payment_service/health;
        }
        location /health/inventory {
            proxy_pass http://inventory_service/health;
        }
        location /health/delivery {
            proxy_pass http://delivery_service/health;
        }
        location /health/notification {
            proxy_pass http://notification_service/health;
        }

        # ── Route: Default → Dashboard (Notification Service) ──
        # Semua request lain diteruskan ke Notification Service (dashboard)
        location / {
            proxy_pass http://notification_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
